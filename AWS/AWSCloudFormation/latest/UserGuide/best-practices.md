
# CloudFormation ベストプラクティス 要約

CloudFormationを安全かつ効率的に運用するための推奨事項です。


## 計画と整理
- テンプレートのlintやテストで早期に問題検出
- スタックはライフサイクルや所有権で分割
- クロススタック参照やStackSetsで複数環境を効率管理
- テンプレートやモジュールの再利用、IaCプラクティス（バージョン管理・CI/CD）を推奨

## テンプレート作成
- 機密情報はテンプレートに埋め込まず動的参照
- パラメータ型や制約、疑似パラメータで移植性・安全性向上
- テンプレートはYAML/JSONで作成し、事前検証・タグ付け・マクロ活用

## スタック管理
- すべてのリソースをCloudFormationで管理
- 変更セットやスタックポリシーで安全に更新
- ドリフト検出やロールバックトリガーで運用リスク低減

## オーサリングツール
- IaC GeneratorやAWS CDKなどのツール活用で効率化

## セキュリティとコンプライアンス
- IAMでアクセス制御、最小権限を徹底
- 機密パラメータはSecrets Manager等で保護
- cfn-guardでテンプレートのポリシー遵守を自動化

---

# CloudFormation ベストプラクティス

CloudFormation のベストプラクティスは、CloudFormation をより効果的に使用し、安全な運用を行うための推奨事項です。スタックの計画と整理、リソースやアプリケーションを定義するテンプレートの作成、スタックおよびリソースの管理方法について学びます。以下のベストプラクティスは、実際の CloudFormation 利用者の経験に基づいています。

---

## 計画と整理

### フィードバックループを短くして開発速度を向上

CloudFormation テンプレートで定義するインフラのフィードバックループを短縮するツールやプラクティスを採用します。ワークステーションでテンプレートを早期に lint したりテストすることで、ソースコードリポジトリに反映する前に潜在的な構文や設定の問題を検出できます。cfn-lint や TaskCat といったツールを使用すると、早期に問題を発見し、スタック作成の成功率を高められます。

### スタックをライフサイクルと所有権で整理

リソースのライフサイクルや所有権に基づいてスタックを整理します。初期段階ではすべてのリソースを1つのスタックにまとめることがありますが、規模が大きくなると管理が困難になります。共通のライフサイクルや所有権を持つリソースをまとめることで、チームごとに独立して変更できます。

例：ウェブサイトを運営するチームは EC2 インスタンスとロードバランサーを管理し、データベース管理チームは別スタックのデータベースを管理します。

### クロススタック参照を使用

別のスタックでエクスポートされた出力値を取得する場合、ハードコードや入力パラメータではなく、Fn::ImportValue 関数を使用したクロススタック参照を活用します。

### AWS CloudFormation StackSets を使用

複数アカウント・複数リージョンへのデプロイには StackSets を使用します。AWS Organizations と組み合わせてサービス管理権限を利用すると、各アカウントに IAM ロールを手動で作成せずにデプロイ可能です。

### リソースのクォータを確認

スタック作成前に、リソース制限に達していないか確認します。制限に達すると、スタック作成が失敗します。

### テンプレートを再利用して複数環境に展開

テンプレートを再利用して、開発・テスト・本番環境に同じ構成を展開できます。パラメータやマッピング、条件を活用して環境ごとの違いを設定します。

### モジュールを使用してリソース構成を再利用

共通のリソースパターンをモジュール化することで、再利用可能で管理しやすいテンプレートを作成できます。モジュールは単一リソース、または複数リソースをまとめた構成でも可能です。

### IaC プラクティスを採用

CloudFormation テンプレートをコードとして扱い、バージョン管理、コードレビュー、自動テストを実施します。CI/CD パイプラインを構築してテンプレートの自動テスト・デプロイを行うことも推奨されます。

---

## テンプレート作成

### 資格情報をテンプレートに埋め込まない

AWS Systems Manager Parameter Store や AWS Secrets Manager の動的参照を使用して、パスワードや API キーなどの機密情報を安全に管理します。

### AWS 固有のパラメータ型を使用

既存の VPC ID や EC2 キーペア名などを入力パラメータとして使う場合、AWS 固有のパラメータ型を使用すると、バリデーションやコンソール上の選択が容易になります。

### パラメータ制約を使用

最小・最大値、パターンなどの制約を設定して、不正な入力値を防ぎます。

### 疑似パラメータを使用して移植性を向上

AWS::Partition, AWS::Region, AWS::AccountId などの疑似パラメータを使用して、テンプレートをリージョンやアカウント間で再利用可能にします。

### AWS::CloudFormation::Init を使用して EC2 にアプリケーションを展開

cfn-init と AWS::CloudFormation::Init リソースを使用して、EC2 インスタンス上のソフトウェアを構成・更新できます。問題発生時にはログを確認可能です。

### 最新のヘルパースクリプトを使用

UserData で `yum install -y aws-cfn-bootstrap` を実行して、最新の CloudFormation ヘルパースクリプトを取得します。

### テンプレートの事前検証

CloudFormation の validate-template コマンドや API を使用して、テンプレートの構文や依存関係の問題を事前に検出します。

### YAML または JSON を使用してテンプレート作成

YAML は可読性やコメントの追加に優れています。JSON は自動生成や API 統合に便利です。テンプレートは可読性・保守性を重視して作成します。

### 包括的なタグ付け戦略を実装

環境、所有者、コストセンター、アプリケーション、用途などのタグをリソースに付与して整理、課金管理、アクセス制御に役立てます。

### テンプレートマクロを活用

テンプレートマクロを使用して、複雑な変換や追加リソース生成を自動化できます。AWS Serverless Application Model はその一例です。

---

## スタック管理

### スタックのリソースはすべて CloudFormation で管理

スタック外でリソースを変更すると、テンプレートとの不整合（ドリフト）が発生します。更新時にはリソース設定が上書きされることがあります。

### 変更セットを作成して更新

変更セットを使うと、スタックを更新する前に影響を確認できます。

### スタックポリシーでリソースを保護

重要リソースへの意図しない変更を防ぐため、スタックポリシーを設定します。

### AWS CloudTrail で CloudFormation 操作をログ

CloudFormation API 呼び出しを CloudTrail で監査可能です。

### コードレビューとリビジョン管理

テンプレートの変更履歴を管理し、変更点を追跡します。

### EC2 インスタンスを定期更新

Windows/Linux インスタンスで yum update を実行し、最新の修正やセキュリティ更新を適用します。

### ドリフト検出を定期実施

CloudFormation ドリフト検出で、テンプレート外で変更されたリソースを特定します。自動化も可能です。

### ロールバックトリガーの設定

CloudWatch アラームを監視し、異常時に自動でスタックをロールバックします。

### スタックリファクタリングの実施

大規模スタックを小分けにしたり、共通リソースをモジュール化したりして、保守性を向上させます。

### CloudFormation Hooks の使用

リソース作成前に設定や準拠状況をチェックし、問題があれば警告や失敗として停止できます。

---

## オーサリングツール

### IaC Generator の使用

既存のリソースから CloudFormation テンプレートを自動生成できます。

### AWS Infrastructure Composer の使用

ドラッグ＆ドロップでテンプレートを視覚的に作成・編集できます。

### AWS CDK の活用

TypeScript, Python, Java, .NET などで複雑なインフラをコード化し、CloudFormation テンプレートを生成できます。

---

## セキュリティとコンプライアンス

### IAM でアクセス制御

ユーザーや CloudFormation サービスの権限を管理します。

### 最小権限の原則を適用

必要最小限の権限だけを付与し、ワイルドカード権限は避けます。

### 機密パラメータの保護

パスワードや API キーは Parameter Store や Secrets Manager を利用し、NoEcho プロパティを設定します。

### AWS CloudFormation Guard の活用

cfn-guard を使ってテンプレートのポリシー遵守を自動チェックし、CI/CD に統合できます。
