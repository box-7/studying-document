
# CloudFormation コンソールからスタックを作成する 要約

- CloudFormationテンプレートを用意し、コンソールやCLIでスタックを作成できる。
- コンソールではウィザード形式で、S3 URLまたはローカルファイルからテンプレートを指定。
- テンプレート検証後、スタック名やパラメータを入力し、オプション（タグ、権限、ロールバック、通知など）を設定。
- IAMリソース作成時は確認チェックが必要。
- 変更セットで事前に構成を確認可能。
- 作成後は「Events」タブで進捗を確認。
- CLIでは `create-stack` コマンド等を利用。

---

# CloudFormation コンソールからスタックを作成する

CloudFormation のテンプレートを作成し、コンソールまたはコマンドラインツールを使ってスタックを作成できます。コンソールではウィザード形式で操作でき、事前定義されたオプションが用意されているため、スタック作成の手順が簡単になります。

---

## スタックの作成

以下の手順でテンプレートをデプロイしてスタックを作成します。

### 前提条件
スタックテンプレートを作成している必要があります。詳細は「CloudFormation テンプレートの操作」を参照してください。

### コンソールでスタックを作成する手順
1. AWS CloudFormation コンソールを開きます: https://console.aws.amazon.com/cloudformation
2. 画面上部のナビゲーションバーで、スタックを作成する AWS リージョンを選択します。
3. 「Stacks」ページで右上の「Create stack」を選び、「With new resources (standard)」を選択します。  
   既存リソースをインポートする場合は「With existing resources (import resources)」を選択します。詳細は「CloudFormation スタックに AWS リソースをインポートする」を参照してください。
4. 「Create stack」ページで以下のいずれかを選択します：
   - **既存のテンプレートを使用する場合**：「Choose an existing template」を選択し、「Specify template」で Amazon S3 URL かローカルファイルのアップロードを選びます。
     - Amazon S3 URL を選ぶ場合は、S3 バケット内のテンプレートファイルの URL を指定します。ネストされたスタックを含む場合は必要なファイルとディレクトリを S3 バケットに含めます。
     - バージョン管理が有効なバケットの場合、URL に `?versionId=version-id` を付与して特定のバージョンを指定できます。
     - URL は最大 1 MB のテンプレートで、S3 バケットへの読み取り権限が必要です。最大文字数は 1024 文字です。一部のリソースはスタックと同じリージョンである必要があります。
   - **ローカルファイルをアップロードする場合**：「Choose File」を選択してローカルからテンプレートを選択します。ファイルサイズは 1 MB 以下である必要があります。

CloudFormation がテンプレートをアップロードすると、S3 URL が表示されます。既存の CloudFormation 作成済みバケットがある場合はそこに追加されます。バケットがない場合はリージョンごとにユニークなバケットを作成します。

**CloudFormation 作成バケットの考慮点**：
- バケットはアカウント内の S3 権限を持つユーザーならアクセス可能です。
- サーバーサイド暗号化がデフォルトで有効です。
- 独自のバケットを使用してアップロードすることも可能です。

テンプレートが準備できていない場合は、Infrastructure Composer を使ってテンプレートを作成できます。

5. 「Next」を選択してテンプレートを検証します。  
   CloudFormation は JSON か YAML の文法チェックを行い、エラーがあれば返します。
6. 「Specify stack details」ページでスタック名を入力します。
   - アルファベットで始まり、英数字とハイフンのみ使用可能、最大 128 文字。
7. Parameters セクションでテンプレートのパラメータ値を指定します。
8. 「Next」を選択します。
9. （任意）「Configure stack options」ページでスタックオプションを変更できます。
10. テンプレートに IAM リソースが含まれる場合、Capabilities で「I acknowledge that this template may create IAM resources」を選択します。
11. 「Next」を選択します。
12. 「Review and create」ページで内容を確認します。必要であれば「Edit」で変更可能です。
13. （任意）Change set を作成してスタック構成を事前に確認できます。
14. 「Submit」を選択してスタックを作成します。CloudFormation がテンプレートで定義されたリソースを作成します。
15. 「Events」タブで作成状況を確認できます。

---

## コマンドラインでスタックを作成する

以下のコマンドを使用できます：
- `create-stack` (AWS CLI)
- `New-CFNStack` (AWS Tools for Windows PowerShell)

詳細は「AWS CLI および PowerShell の CloudFormation スタック操作コマンド例」を参照してください。

---

## スタックオプションの設定

「Configure stack options」ページでは以下を設定可能です：

### タグ
- スタックおよびリソースに最大 50 個のタグを追加可能
- Key: 最大 127 文字、Value: 最大 255 文字
- スタック作成後のタグ追加・更新・削除はスタックの更新をトリガー

### 権限
- CloudFormation が利用する既存の IAM サービスロールを指定可能

### スタック失敗オプション
- CREATE_FAILED または UPDATE_FAILED 時にロールバックするか、成功したリソースは保持するかを設定可能

### 高度なオプション
- **スタックポリシー**: 更新から保護したいリソースを JSON で指定
- **ロールバック設定**: CloudWatch アラームでスタック作成/更新時に条件を満たすとロールバック
- **通知オプション**: SNS トピックにスタックイベント通知
- **タイムアウト**: スタック作成の最大時間を分単位で指定
- **削除保護**: 有効にすると誤って削除できない

---

## スタック構成のプレビュー

- 変更セットを作成して、スタック作成前に構成を確認できます
- 新規スタックの場合、変更セット作成後に「Execute」を選択してスタック作成を完了できます
- 変更セット作成中は `CREATE_IN_PROGRESS`、完了後は `CREATE_COMPLETE`、実行可能になると `AVAILABLE` ステータスになります
