
# AWS CloudFormation の仕組み 要約

- **テンプレート**: YAML/JSON形式でAWSリソースや設定を記述する設計図。パラメータで再利用性も高い。
- **スタック**: テンプレートからまとめてリソースを作成・管理する単位。作成・更新・削除が一括で可能。
- **変更セット**: スタック更新時、変更内容を事前に確認できる仕組み。影響範囲を把握してから適用できる。

**動作の流れ**  
1. テンプレートを作成（エディタやInfrastructure Composer利用可）
2. テンプレートをローカルやS3に保存
3. スタック作成時にテンプレートとパラメータを指定
4. CloudFormationがAWSサービスAPIを呼び出しリソースを構築
5. 失敗時は自動ロールバック

**更新時**  
- テンプレート修正→変更セット作成→内容確認→適用で安全に更新

**学習方法**  
- コンソールのチュートリアルや公式ワークショップでハンズオン学習が可能

---

# AWS CloudFormation の仕組み

## トピック
- Key concepts
- How CloudFormation works
- Ways to get started with CloudFormation

---

## Key concepts

CloudFormation を使用する際には、テンプレートとスタックを使います。テンプレートを作成して AWS リソースとそのプロパティを記述します。スタックを作成すると、CloudFormation がテンプレートに記述されたリソースをプロビジョニングします。

### テンプレート (Templates)
CloudFormation テンプレートは YAML または JSON 形式のテキストファイルです。拡張子は .yaml、.json、.template、.txt などで保存できます。CloudFormation はこれらのテンプレートを AWS リソースを構築するための設計図として使用します。  

例として、テンプレートでは Amazon EC2 インスタンスのタイプ、AMI ID、ブロックデバイスマッピング、EC2 キーペア名などを記述できます。スタックを作成するときに、CloudFormation がそのテンプレートを使ってリソースを作成します。

#### 例: 単一 EC2 インスタンスのテンプレート
テンプレートには、AMI ID が ami-0ff8a91507f77f867、インスタンスタイプが t2.micro、キーペア名が testkey の EC2 インスタンスと EBS ボリュームを定義しています。

複数のリソースを 1 つのテンプレートに指定し、相互に連携させることもできます。例えば、EC2 インスタンスに Elastic IP アドレス (EIP) を追加して紐付けることも可能です。

テンプレートはスタック作成時に入力パラメータを指定できるため、インスタンスタイプなどの値をテンプレート作成時ではなくスタック作成時に決めることができ、テンプレートの再利用性が高まります。

---

### スタック (Stacks)
CloudFormation では、関連するリソースをスタックと呼ばれる単位で管理します。スタックの作成、更新、削除により、複数のリソースをまとめて操作できます。スタックに含まれるすべてのリソースはスタックの CloudFormation テンプレートで定義されます。

例として、Auto Scaling グループ、Elastic Load Balancing ロードバランサー、RDS データベースインスタンスを含むテンプレートがある場合、スタックを作成すると、それらのリソースすべてがプロビジョニングされます。

---

### 変更セット (Change sets)
スタック内のリソースを変更する場合、スタックを更新します。リソース変更前に、提案される変更内容の概要を示す変更セットを生成できます。変更セットにより、変更が実行中のリソースにどのような影響を与えるかを確認できます。  

例として、RDS データベースの名前を変更すると、CloudFormation は新しいデータベースを作成し、古いデータベースを削除します。古いデータベースのデータはバックアップしていない場合は失われます。変更セットを生成すると、どのリソースが置き換えられるかを事前に確認可能です。

---

## How CloudFormation works

CloudFormation でスタックを作成すると、CloudFormation は AWS のサービスコールを実行して、テンプレートに記述されたリソースをプロビジョニングおよび構成します。リソースを作成するための権限が必要です。例えば、EC2 インスタンスを作成するには EC2 インスタンス作成の権限が必要であり、これらの権限は IAM で管理します。

CloudFormation が行うコールはすべてテンプレートで宣言されます。例えば、t2.micro インスタンスの EC2 インスタンスをテンプレートで定義した場合、スタック作成時に CloudFormation は EC2 の CreateInstance API を呼び出し、インスタンスタイプを t2.micro として指定します。

### スタック作成の手順
1. テキストエディタで YAML または JSON 形式の CloudFormation テンプレートを作成
2. Infrastructure Composer を使用してテンプレートを可視化・検証
3. テンプレートをローカルまたは S3 バケットに保存
4. スタックを作成し、テンプレートの場所（ローカルパスまたは S3 URL）を指定
5. パラメータがある場合はスタック作成時に値を指定
6. すべてのリソース作成後、CloudFormation がスタック作成完了を報告
7. スタック作成に失敗した場合は、作成したリソースを削除してロールバック

---

### スタック更新 (Change sets を使った更新)
1. CloudFormation スタックテンプレートを修正
2. 修正テンプレートやパラメータを元に変更セットを作成
3. 変更セットで CloudFormation が提案する変更内容を確認
4. 変更セットを適用してスタックを更新（修正したリソースのみ更新）
5. 更新に失敗した場合はロールバックされ、最後の正常な状態に戻る

> 注意: 変更セットは更新成功を保証せず、リソース制限や権限不足による失敗は検出できません。

---

## Ways to get started with CloudFormation
- コンソールで「Hello World」スタックを作成するチュートリアルを参照
- 「Getting Started with AWS CloudFormation Workshop」でテンプレート作成やスタック操作をハンズオンで学習可能
