# ã‚„ã‚‹ã“ã¨
æœ€å¾Œã®èª²é¡Œã¯ã“ã‚Œã¾ã§ä½œæˆã—ãŸãƒªã‚½ãƒ¼ã‚¹ã‚’cloudformationã§è‡ªå‹•ã§å…¨ã¦ä½œæˆã™ã‚‹ã‚ˆã†ã«ã—ã¦ãã ã•ã„ï¼  

cloudformationã¯vpcã‹ã‚‰æ‰‹ã§ä½œã£ã¦ã„ãŸã‚‚ã®ã‚’1ã¤ãšã¤åŒã˜è¨­å®šã«ã—ã¦ä½œã£ã¦ã„ã£ã¦ãã ã•ã„  
ã“ã“ã¯AIä½¿ã£ã¡ã‚ƒã£ã¦ã‚‚è‰¯ã„ã®ã§ã€ç†è§£ã ã‘ã¯ã¡ã‚ƒã‚“ã¨ã—ã¦é€²ã‚ã¦ã»ã—ã„ã§ã™  

æ‰‹ä½œæ¥­ã§cloudformationã‹ã‚‰ãƒªã‚½ãƒ¼ã‚¹å»ºã¦ã‚‰ã‚Œã‚Œã°okã§ã™
ãã‚‚ãã‚‚CICDã§æ¯åº¦ãƒªã‚½ãƒ¼ã‚¹ä½œã‚‹ãªã©ã¯ãªã„ã®ã§


# IaC ã¨ CloudFormation ã®ã¾ã¨ã‚

## 1. IaC ã¨ã¯
**IaC (Infrastructure as Code)**  
ã‚¤ãƒ³ãƒ•ãƒ©æ§‹æˆï¼ˆã‚µãƒ¼ãƒãƒ¼ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€DBãªã©ï¼‰ã‚’ã‚³ãƒ¼ãƒ‰ã§ç®¡ç†ã™ã‚‹æ‰‹æ³•ã€‚  

### ç‰¹å¾´
- æ‰‹ä½œæ¥­ã§ GUI ã‹ã‚‰è¨­å®šã™ã‚‹ã®ã§ã¯ãªãã€ã‚³ãƒ¼ãƒ‰ã‚„ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§å®£è¨€çš„ã«æ§‹ç¯‰ãƒ»ç®¡ç†
- å†ç¾æ€§ãƒ»è‡ªå‹•åŒ–ãƒ»ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒ»ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½

### ä¾‹
- CloudFormation ã® YAML/JSON ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ
- Terraform ã® HCL ãƒ•ã‚¡ã‚¤ãƒ«
- Ansible ã® playbook

---

## 2. ã‚³ãƒ¼ãƒ‰åŒ–ã—ãŸãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ç®¡ç†
- GitHub ãªã©ã®ãƒãƒ¼ã‚¸ãƒ§ãƒ³ç®¡ç†ãƒªãƒã‚¸ãƒˆãƒªã«ç½®ã
  - å¤‰æ›´å±¥æ­´ãŒæ®‹ã‚‹ â†’ èª°ãŒã„ã¤ä½•ã‚’å¤‰æ›´ã—ãŸã‹è¿½ãˆã‚‹
  - ãƒãƒ¼ãƒ ã§ãƒ¬ãƒ“ãƒ¥ãƒ¼å¯èƒ½ â†’ IaC ã‚’å®‰å…¨ã«æ›´æ–°
  - CI/CD ã«çµ„ã¿è¾¼ã‚ã‚‹ â†’ è‡ªå‹•ã§ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆã‚„ãƒ†ã‚¹ãƒˆå¯èƒ½

### é…ç½®ä¾‹
```
my-project/
â”œâ”€ infrastructure/ â† IaC ç”¨ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª
â”‚ â”œâ”€ vpc.yaml
â”‚ â”œâ”€ ec2-stack.yaml
â”‚ â””â”€ s3-buckets.yaml
â”œâ”€ src/ â† ã‚¢ãƒ—ãƒªã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰
â””â”€ README.md
```

---

## 3. CloudFormation ã®ãƒ¡ãƒªãƒƒãƒˆ
- è¨­è¨ˆå›³ï¼ˆãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰ã‹ã‚‰ãƒœã‚¿ãƒ³ä¸€ã¤ã§ AWS ç’°å¢ƒã‚’è‡ªå‹•æ§‹ç¯‰ãƒ»ç®¡ç†
- åŒã˜ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã§é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆãƒ»æœ¬ç•ªç’°å¢ƒã‚’è¤‡è£½å¯èƒ½
- æ›´æ–°ã‚‚ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ä¿®æ­£ã—ã¦ã‚¹ã‚¿ãƒƒã‚¯ã‚’æ›´æ–°ã™ã‚‹ã ã‘
- ä¾å­˜é–¢ä¿‚ã®è‡ªå‹•ç®¡ç†ã€ãƒ‰ãƒªãƒ•ãƒˆæ¤œå‡ºã€ãƒ­ãƒ¼ãƒ«ãƒãƒƒã‚¯è¨­å®šãŒå¯èƒ½
- ãƒãƒ¼ãƒ ã§ã®å¤‰æ›´å±¥æ­´ã‚„ãƒ¬ãƒ“ãƒ¥ãƒ¼ãŒå¯èƒ½

---

## 4. CI/CD ã«ãŠã‘ã‚‹ IaC ã®ç›®çš„
- **ãƒ†ã‚¹ãƒˆç”¨ç’°å¢ƒã®è‡ªå‹•ä½œæˆ**
  - PR ä½œæˆæ™‚ã«ä¸€æ™‚çš„ãªã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œã‚Šã€å‹•ä½œç¢ºèª
- **æœ¬ç•ªç’°å¢ƒã¸ã®å®‰å…¨ãªå·®åˆ†æ›´æ–°**
  - CloudFormation ã® Change Set ã‚’ä½œã£ã¦å·®åˆ†ã®ã¿åæ˜ 
  - å…¨ãƒªã‚½ãƒ¼ã‚¹ã‚’æ¯å›ä½œã‚Šç›´ã™ã‚ã‘ã§ã¯ãªã„

### æµã‚Œä¾‹ï¼ˆGitHub Actions + CloudFormationï¼‰
```
GitHub PR ä½œæˆ
â”‚
â””â”€> CI ãŒãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ¤œè¨¼ï¼ˆlint/validateï¼‰
â”‚
â””â”€> ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ãƒƒã‚¯ã‚’ AWS ã«ä½œæˆï¼ˆå‹•ä½œç¢ºèªï¼‰
â”‚
â””â”€> ãƒ†ã‚¹ãƒˆçµ‚äº†å¾Œã¯ã‚¹ã‚¿ãƒƒã‚¯ã‚’å‰Šé™¤
```


- é–‹ç™ºãƒ»ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ãƒƒã‚¯ã¯ä½¿ã„æ¨ã¦
- æœ¬ç•ªç”¨ã‚¹ã‚¿ãƒƒã‚¯ã¯å·®åˆ†æ›´æ–°ã ã‘

---

## 5. CloudFormation ã® `validate-template` ã®ç›®çš„
- ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒæ­£ã—ã„ JSON/YAML å½¢å¼ã‹ç¢ºèª
- å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚„ãƒªã‚½ãƒ¼ã‚¹æ§‹æ–‡ãŒæ­£ã—ã„ã‹ç¢ºèª
- AWS CLI ãŒç†è§£ã§ãã‚‹æ§‹é€ ã«ãªã£ã¦ã„ã‚‹ã‹ç¢ºèª

> â€» å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã§ãã‚‹ã‹ã¯ç¢ºèªã§ããªã„



GitHub Actions ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã‚µãƒ³ãƒ—ãƒ«
```
name: CI/CD with IaC

on:
  pull_request:
    branches: [main]

jobs:
  iac-test:
    runs-on: ubuntu-latest
    steps:
      # 1. ã‚³ãƒ¼ãƒ‰ã®ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. AWS CLI è¨­å®š
      - name: Configure AWS CLI
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ap-northeast-1

      # 3. CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®æ¤œè¨¼
      - name: Validate CloudFormation template
        run: |
          aws cloudformation validate-template --template-body file://infrastructure/template.yaml

      # 4. ãƒ†ã‚¹ãƒˆç”¨ã‚¹ã‚¿ãƒƒã‚¯ä½œæˆ
      - name: Create test stack
        run: |
          STACK_NAME="test-stack-${{ github.run_id }}"
          aws cloudformation create-stack \
            --stack-name $STACK_NAME \
            --template-body file://infrastructure/template.yaml \
            --capabilities CAPABILITY_NAMED_IAM
          aws cloudformation wait stack-create-complete --stack-name $STACK_NAME

      # 5. çµ±åˆãƒ†ã‚¹ãƒˆå®Ÿè¡Œï¼ˆã‚¹ã‚¿ãƒƒã‚¯å†…ãƒªã‚½ãƒ¼ã‚¹ã‚’åˆ©ç”¨ï¼‰
      - name: Run integration tests
        run: |
          npm ci
          npm run test:integration

      # 6. ãƒ†ã‚¹ãƒˆå¾Œã‚¹ã‚¿ãƒƒã‚¯å‰Šé™¤
      - name: Delete test stack
        if: always()
        run: |
          aws cloudformation delete-stack --stack-name $STACK_NAME
          aws cloudformation wait stack-delete-complete --stack-name $STACK_NAME
```



# âœ… CloudFormation ã§å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹æ–¹æ³•

CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆYAML ãƒ•ã‚¡ã‚¤ãƒ«ï¼‰ã¯ **è¨­è¨ˆå›³** ã«ã‚ãŸã‚Šã¾ã™ã€‚  
ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã€Œã‚¤ãƒ³ãƒãƒ¼ãƒˆã€ã—ãŸã ã‘ã§ã¯ãƒªã‚½ãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚  
å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œã‚‹ã«ã¯ã€**ã‚¹ã‚¿ãƒƒã‚¯ã‚’ä½œæˆ** ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---

## ğŸ”¹ æ–¹æ³•â‘ ï¼šAWS CLI ã§ä½œæˆ

```bash
aws cloudformation create-stack \
  --stack-name MyStack \
  --template-body file://infra/main.yml \
  --capabilities CAPABILITY_IAM
```

### èª¬æ˜

- `--stack-name` : ã‚¹ã‚¿ãƒƒã‚¯åï¼ˆä»»æ„ã®åå‰ï¼‰  
- `--template-body` : CloudFormation ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®ãƒ‘ã‚¹  
- `--capabilities CAPABILITY_IAM` : ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆãŒ IAM ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½œæˆã™ã‚‹å ´åˆã«å¿…è¦

### ä½œæˆã•ã‚Œã‚‹ãƒªã‚½ãƒ¼ã‚¹ä¾‹

- VPC  
- ã‚µãƒ–ãƒãƒƒãƒˆ  
- ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚°ãƒ«ãƒ¼ãƒ—  
- ãã®ä»–ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«è¨˜è¿°ã•ã‚ŒãŸ AWS ãƒªã‚½ãƒ¼ã‚¹

## ğŸ”¹ æ–¹æ³•â‘¡ï¼šAWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã‹ã‚‰ä½œæˆ

1. AWS ãƒãƒã‚¸ãƒ¡ãƒ³ãƒˆã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ **CloudFormation** ã‚’é–‹ã  
2. ã€Œ**ã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆ**ã€ â†’ ã€Œ**æ–°ã—ã„ãƒªã‚½ãƒ¼ã‚¹ã‚’ä½¿ç”¨**ã€ ã‚’é¸æŠ  
3. ã€Œ**ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰**ã€ ã‚’é¸ã³ã€`main.yml` ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰  
4. ã€Œ**æ¬¡ã¸**ã€ã‚’æŠ¼ã—ã¦ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å…¥åŠ›  
5. ã€Œ**ã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆ**ã€ã‚’ã‚¯ãƒªãƒƒã‚¯  

### çµæœ

æ•°åˆ†å¾Œã€AWS ä¸Šã«å®Ÿéš›ã®ãƒªã‚½ãƒ¼ã‚¹ï¼ˆä¾‹ï¼šVPC ãªã©ï¼‰ãŒä½œæˆã•ã‚Œã¾ã™ã€‚


### âš ï¸ æ³¨æ„äº‹é …

- `validate-template` ã¯æ§‹æ–‡ãƒã‚§ãƒƒã‚¯ã®ã¿ã§ã€ãƒªã‚½ãƒ¼ã‚¹ã¯ä½œæˆã•ã‚Œã¾ã›ã‚“ã€‚  
- `create-stack` / `deploy` ã‚³ãƒãƒ³ãƒ‰ã‚„ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§ã®ã€Œã‚¹ã‚¿ãƒƒã‚¯ã®ä½œæˆã€ã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å®Ÿéš›ã«ãƒªã‚½ãƒ¼ã‚¹ãŒä½œã‚‰ã‚Œã¾ã™ã€‚  
- äº‹å‰ã« `Parameters`ï¼ˆä¾‹ï¼š`VpcCidr`ï¼‰ã‚„ `Capabilities`ï¼ˆIAM ã‚’ä½œã‚‹å ´åˆï¼‰ã‚’æ­£ã—ãè¨­å®šã—ã¦ãŠãå¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚


