## ğŸ§© è‡ªåˆ†ãƒ¡ãƒ¢ã€€ã‚³ãƒãƒ³ãƒ‰æ§‹é€ ã®èª¬æ˜

```bash
pm2 start npm --name api-server -- run server
```

| éƒ¨åˆ† | æ„å‘³ |
|------|------|
| `pm2 start` | PM2ã§æ–°ã—ã„ãƒ—ãƒ­ã‚»ã‚¹ã‚’èµ·å‹•ã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ |
| `npm` | å®Ÿè¡Œã™ã‚‹ã‚³ãƒãƒ³ãƒ‰ã€‚ã“ã“ã§ã¯ Node.js ã®ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ npm |
| `--name api-server` | PM2ä¸Šã§ã“ã®ãƒ—ãƒ­ã‚»ã‚¹ã«ã€Œapi-serverã€ã¨ã„ã†åå‰ã‚’ã¤ã‘ã‚‹ï¼ˆç®¡ç†ã—ã‚„ã™ããªã‚‹ï¼‰ |
| `--` | ã“ã‚Œä»¥é™ã¯ npm ã«æ¸¡ã™å¼•æ•°ã¨ã„ã†æ„å‘³ï¼ˆPM2ã¨npmã®å¼•æ•°ã‚’åŒºåˆ¥ã™ã‚‹ãŸã‚ã®åŒºåˆ‡ã‚Šï¼‰ |
| `run server` | npm ã«ã€Œrun serverã€ã‚’å®Ÿè¡Œã•ã›ã‚‹ã€‚ã¤ã¾ã‚Š `npm run server` ã¨åŒã˜æ„å‘³ |


## ğŸ§© npm list

| id | name        | namespace | version | mode  | pid    | uptime | â†º | status  | cpu | mem     | user     | watching |
|----|--------------|------------|----------|--------|--------|--------|---|----------|-----|---------|-----------|-----------|
| 0  | api-server   | default    | N/A      | fork   | 123456 | 2D     | 0 | online  | 0%  | 59.0mb | sample-user | enabled ã¾ãŸã¯ disabled |



# PM2 ãƒãƒ¼ãƒˆã‚·ãƒ¼ãƒˆï¼ˆPM2ã®å®Ÿé‹ç”¨ã§è¦šãˆã¦ãŠãã¹ãé …ç›®ï¼‰


## 1. åŸºæœ¬æ“ä½œ
```bash
# ã‚¢ãƒ—ãƒªå˜ä½“
pm2 start app.js
pm2 stop app.js
pm2 restart app.js
pm2 delete app.js

# è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã§è¤‡æ•°ã‚¢ãƒ—ãƒªã‚’ç®¡ç†
pm2 start ecosystem.config.js
pm2 stop ecosystem.config.js
pm2 restart ecosystem.config.js
pm2 delete ecosystem.config.js
```

## 2. ãƒ—ãƒ­ã‚»ã‚¹ç®¡ç†
name / idï¼šã‚¢ãƒ—ãƒªè­˜åˆ¥ç”¨

instancesï¼šCPUã«åˆã‚ã›ã¦è¤‡æ•°ãƒ—ãƒ­ã‚»ã‚¹èµ·å‹•ï¼ˆã‚¯ãƒ©ã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ‰ï¼‰

exec_modeï¼šforkï¼ˆå˜ä¸€ï¼‰ / clusterï¼ˆãƒãƒ«ãƒï¼‰


```js
module.exports = {
  apps: [{
    name: "api-app",
    script: "./api.js",
    instances: 4,
    exec_mode: "cluster"
  }]
}
```

## 3. å†èµ·å‹•é–¢é€£
- autorestartï¼šè½ã¡ãŸã‚‰è‡ªå‹•å†èµ·å‹•

- max_restartsï¼šçŸ­æ™‚é–“ã§ã®å†èµ·å‹•å›æ•°åˆ¶é™

- restart_delayï¼šå†èµ·å‹•å‰ã®å¾…æ©Ÿæ™‚é–“ï¼ˆmsï¼‰

- cron_restartï¼šå®šæœŸå†èµ·å‹•ï¼ˆcronå½¢å¼ï¼‰

- watch / ignore_watchï¼šã‚³ãƒ¼ãƒ‰å¤‰æ›´æ™‚ã®è‡ªå‹•å†èµ·å‹•

js
```
watch: true,
ignore_watch: ["node_modules", "logs"],
autorestart: true,
restart_delay: 3000,
max_restarts: 10,
cron_restart: "0 0 * * *"
```

## 4. ãƒ­ã‚°ç®¡ç†
- out_file / error_fileï¼šå‡ºåŠ›å…ˆæŒ‡å®š

- merge_logsï¼šã‚¯ãƒ©ã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ‰ã§ãƒ­ã‚°ã‚’1ãƒ•ã‚¡ã‚¤ãƒ«ã«ã¾ã¨ã‚ã‚‹

- log_date_formatï¼šãƒ­ã‚°ã«æ—¥ä»˜ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ

- pm2 logsï¼šãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ­ã‚°ç¢ºèª

- pm2 flushï¼šãƒ­ã‚°ã®ã‚¯ãƒªã‚¢

bash
```
pm2 logs                 # å…¨ã‚¢ãƒ—ãƒªã®ãƒ­ã‚°
pm2 logs api-app         # ç‰¹å®šã‚¢ãƒ—ãƒªã®ãƒ­ã‚°
pm2 flush                # å…¨ã‚¢ãƒ—ãƒªã®ãƒ­ã‚°ã‚¯ãƒªã‚¢
pm2 flush api-app        # ç‰¹å®šã‚¢ãƒ—ãƒªã®ãƒ­ã‚°ã‚¯ãƒªã‚¢
```

## 5. ç’°å¢ƒåˆ‡æ›¿
env / env_production / env_development

èµ·å‹•æ™‚ã« --env <envname> ã§åˆ‡ã‚Šæ›¿ãˆ

js
```
env: { NODE_ENV: "development" },
env_production: { NODE_ENV: "production" }
```

bash
```
pm2 start ecosystem.config.js --env production
pm2 restart ecosystem.config.js --env development
```

## 6. æ°¸ç¶šåŒ–ï¼ˆã‚µãƒ¼ãƒå†èµ·å‹•å¾Œã‚‚è‡ªå‹•èµ·å‹•ï¼‰
bash
```
pm2 startup              # èµ·å‹•ã‚¹ã‚¯ãƒªãƒ—ãƒˆç”Ÿæˆ
sudo su -c "..."         # rootæ¨©é™ã§å®Ÿè¡Œï¼ˆæç¤ºã•ã‚Œã‚‹ã‚³ãƒãƒ³ãƒ‰ï¼‰
pm2 save                 # èµ·å‹•ä¸­ã®ã‚¢ãƒ—ãƒªã‚’ä¿å­˜
pm2 resurrect            # ä¿å­˜æ¸ˆã¿ã‚¢ãƒ—ãƒªã‚’æ‰‹å‹•ã§å¾©å…ƒ
pm2 unstartup            # è‡ªå‹•èµ·å‹•è¨­å®šã‚’è§£é™¤
```

## 7. ãŠã™ã™ã‚é‹ç”¨ãƒã‚¤ãƒ³ãƒˆ
- æœ€åˆã¯ ã€Œèµ·å‹•ãƒ»åœæ­¢ãƒ»å†èµ·å‹•ã€ã¨ã€Œãƒ­ã‚°ç¢ºèªã€ ã ã‘è¦šãˆã‚‹
- æ…£ã‚ŒãŸã‚‰ ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¢ãƒ¼ãƒ‰ã€watchã€è‡ªå‹•å†èµ·å‹•ã€æ°¸ç¶šåŒ– ã‚’è¿½åŠ 
- ãƒ­ã‚°ã¯å¿…ãšæ®‹ã™ï¼ˆéšœå®³èª¿æŸ»ã®ãŸã‚ï¼‰
- é–‹ç™ºç’°å¢ƒã¨æœ¬ç•ªç’°å¢ƒã¯ --env ã§åˆ‡ã‚Šæ›¿ãˆ




# PM2 ã«ã‚ˆã‚‹ CPU / ãƒ¡ãƒ¢ãƒªç›£è¦–

https://pm2.keymetrics.io/docs/usage/monitoring/  

1. PM2 Monit

ã‚¿ãƒ¼ãƒŸãƒŠãƒ«ã‹ã‚‰ç°¡å˜ã«ã‚¢ãƒ—ãƒªã® CPU ã¨ãƒ¡ãƒ¢ãƒªä½¿ç”¨é‡ ã‚’ç›£è¦–å¯èƒ½
```
pm2 monit
```

2. PM2.io
- è¤‡æ•°ã‚µãƒ¼ãƒãƒ¼ã§å‹•ã Node.js ã‚¢ãƒ—ãƒªã‚’ Web ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰ã§ç›£è¦–ãƒ»ç®¡ç†
- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ã‚„ã‚¢ãƒ—ãƒªçŠ¶æ…‹ã‚’ç¢ºèªã§ãã‚‹
- PM2.io ã§ã‚ˆã‚Šç°¡å˜ã«ç›£è¦–ãƒ»ç®¡ç†ãŒå¯èƒ½

3. ãƒ¡ãƒ¢ãƒªé–¾å€¤ã§ã®è‡ªå‹•ãƒªãƒ­ãƒ¼ãƒ‰
- ã‚¢ãƒ—ãƒªãŒè¨­å®šã—ãŸ ãƒ¡ãƒ¢ãƒªä¸Šé™ ã‚’è¶…ãˆã‚‹ã¨è‡ªå‹•ã§ãƒªãƒ­ãƒ¼ãƒ‰ï¼ˆå†èµ·å‹•ã«ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
- å†…éƒ¨ãƒã‚§ãƒƒã‚¯ã¯ 30ç§’ã”ã¨ ã«è¡Œã‚ã‚Œã‚‹ãŸã‚ã€å³æ™‚åå¿œã§ã¯ãªã„

![](image.png)











